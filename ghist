#!/usr/bin/env ruby

require 'optparse'

require 'colorize'

options = {regex: false}
history_filenames = Dir[Dir.home << "/.*sh_history"]
query = nil

OptionParser.new do |opts|

  opts.banner =
    ["Usage: ghist [options] QUERY",
    "Starts a WEBrick HTTP server from the current directory"].
    join "\n"

  opts.on("-r", "--regex", "Consider QUERY a Ruby regex") do |r|
    options[:regex] = true
  end

end.parse!

if ARGV.empty? || ARGV[0].empty?
  puts "No query provided; exiting"
  abort
end

query = options[:regex] ? Regexp.new(ARGV[0]) : ARGV[0]
history_content = history_filenames.
  map { |s| File.read(s) }.
  join("\n").
  encode('UTF-8', invalid: :replace).
  split("\n").
  map(&:strip).
  uniq
history_matches = history_content.select { |s| s[query] }
history_matches.map! { |s| s.gsub query, s[query].light_green.bold }

history_matches.each do |s|
  puts s
end


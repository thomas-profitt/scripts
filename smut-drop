#!/usr/bin/env ruby

require 'shellwords'
require 'resolv'
require 'socket'
require 'fileutils'
require 'pathname'

user = "tom"
host = "owlbear"
smut_path = Pathname.new("/home/tom/.porn/Unsorted").cleanpath

if Socket.ip_address_list.map(&:ip_address).include? Resolv.getaddress(host)

  puts "Script being ran from #{host}; simply moving files."
  ARGV.each do |fn|
    FileUtils.mv fn, smut_path
  end
  exit

else

  begin
    Resolv.getaddress host
  rescue Resolv::ResolvError
    puts "Unable to resolve hostname \"#{host}\"; aborting"
    abort
  end

  files_to_copy = []

  ARGV.each do |fn|
    if File.exist? fn
      files_to_copy << fn
    else
      puts "File \"#{fn}\" does not exist; skipping"
      next
    end
  end

  `scp #{files_to_copy.map{ |fn| Shellwords.shellescape fn }.join(" ")} #{user}@#{host}:#{Shellwords.shellescape(smut_path)}`

  if $?.exitstatus == 0
    puts "scp exit status 0; removing local files"
    files_to_copy.each do |fn|
      puts "Transferred #{fn} with exit-status 0. Removing file."
      FileUtils.rm fn
    end
  else
    puts "scp exited with a failure exit code; local files not deleted."
  end

end